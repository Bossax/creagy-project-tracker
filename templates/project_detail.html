{% extends "base.html" %}
{% block title %}{{ project.name }} â€¢ Creagy Project Tracker{% endblock %}
{% block head_extra %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.css">
{% endblock %}
{% block content %}
<div class="mb-4">
  <a class="btn btn-link ps-0" href="{{ url_for('dashboard') }}">&larr; Back to dashboard</a>
</div>
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <div class="row">
      <div class="col-lg-8">
        <h2 class="h4">{{ project.name }}</h2>
        <p class="mb-1">
          <strong>Client:</strong> {{ project.client.name }}<br>
          <strong>Project Manager:</strong> {{ project.project_manager.name }}<br>
          <strong>Team:</strong> {{ project.team.name }}<br>
          <strong>Timeline:</strong> {{ project.start_date.strftime('%Y-%m-%d') }} &rarr; {{ project.end_date.strftime('%Y-%m-%d') }}
        </p>
      </div>
      <div class="col-lg-4 d-flex align-items-center">
        <div class="w-100">
          <div class="row text-center">
            <div class="col-4">
              <div class="stat-box">
                <div class="stat-label">Duration (months)</div>
                <div class="stat-value">{{ summary_stats.duration_months }}</div>
              </div>
            </div>
            <div class="col-4">
              <div class="stat-box">
                <div class="stat-label">Total Manday</div>
                <div class="stat-value">{{ summary_stats.total_manday }}</div>
              </div>
            </div>
            <div class="col-4">
              <div class="stat-box">
                <div class="stat-label">Total Budget</div>
                <div class="stat-value">{{ summary_stats.total_budget | round(2) }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% if can_manage_tasks %}
<div class="card shadow-sm mb-4">
  <div class="card-header bg-secondary text-white">
    <h5 class="mb-0">Add Task</h5>
  </div>
  <div class="card-body">
    <form method="post" action="{{ url_for('create_task', project_id=project.id) }}" id="task-form">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label" for="task_name">Task Name</label>
          <input class="form-control" id="task_name" name="task_name" required>
        </div>
        <div class="col-md-3">
          <label class="form-label" for="assignee_id">Assignee</label>
          <select class="form-select" id="assignee_id" name="assignee_id" required>
            <option value="">Select employee</option>
            {% for employee in employees %}
            <option value="{{ employee.id }}">{{ employee.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-1">
          <label class="form-label" for="manday">Manday</label>
          <input class="form-control" id="manday" name="manday" type="number" step="0.1" min="0" value="0">
        </div>
        <div class="col-md-2">
          <label class="form-label" for="budget">Budget</label>
          <input class="form-control" id="budget" name="budget" type="number" step="0.01" min="0" value="0">
        </div>
      </div>
      <div class="row g-3 mt-2">
        <div class="col-md-4">
          <label class="form-label" for="status">Status</label>
          <select class="form-select" id="status" name="status">
            <option value="Planned" selected>Planned</option>
            <option value="In Progress">In Progress</option>
            <option value="Completed">Completed</option>
          </select>
        </div>
      </div>
      <div class="mt-4">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Timeline &amp; Activity</h6>
          <button class="btn btn-sm btn-outline-primary" type="button" id="add-activity-row">Add Month</button>
        </div>
        <div id="activity-rows">
          <div class="row g-3 activity-row-group mt-1">
            <div class="col-md-5">
              <label class="form-label">Month</label>
              <select class="form-select" name="month_ids[]" required>
                <option value="">Select month</option>
                {% for month in months %}
                <option value="{{ month.id }}">{{ month.yyyy_mm }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-5">
              <label class="form-label">Activity Type</label>
              <select class="form-select" name="activity_ids[]" required>
                <option value="">Select activity</option>
                {% for activity in activities %}
                <option value="{{ activity.id }}">{{ activity.type }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <button class="btn btn-outline-danger w-100 remove-row" type="button">Remove</button>
            </div>
          </div>
        </div>
      </div>
      <div class="d-grid mt-4">
        <button class="btn btn-primary" type="submit">Create Task</button>
      </div>
    </form>
  </div>
</div>
{% endif %}

<div class="row">
  <div class="col-lg-8 mb-4">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Gantt Timeline</h5>
      </div>
      <div class="card-body">
        {% if project.tasks %}
        <div id="gantt-chart"></div>
        {% else %}
        <p class="text-muted mb-0">Add a task to generate the Gantt chart.</p>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-lg-4 mb-4">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0">Monthly Manday</h5>
      </div>
      <div class="card-body">
        {% if project.tasks %}
        <canvas id="mandayChart" height="250"></canvas>
        {% else %}
        <p class="text-muted mb-0">Manday chart will appear once tasks are added.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-header bg-light">
    <h5 class="mb-0">Tasks</h5>
  </div>
  <div class="card-body">
    {% if project.tasks %}
    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th>Name</th>
            <th>Assignee</th>
            <th>Manday</th>
            <th>Budget</th>
            <th>Status</th>
            <th>Timeline</th>
          </tr>
        </thead>
        <tbody>
          {% for task in project.tasks %}
          <tr>
            <td class="fw-semibold">{{ task.name }}</td>
            <td>{{ task.assignee.name }}</td>
            <td>{{ task.manday }}</td>
            <td>{{ task.budget }}</td>
            <td><span class="badge bg-secondary">{{ task.status }}</span></td>
            <td>
              {% set activities = task_map.get(task.id, []) %}
              {% if activities %}
              <ul class="list-unstyled mb-0">
                {% for activity in activities %}
                <li>
                  <span class="badge bg-info-subtle text-info-emphasis">{{ activity.month.yyyy_mm }}</span>
                  <small class="text-muted">{{ activity.activity.type }}</small>
                </li>
                {% endfor %}
              </ul>
              {% else %}
              <span class="text-muted">No timeline</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-muted mb-0">No tasks yet. {% if can_manage_tasks %}Use the form above to add one.{% endif %}</p>
    {% endif %}
  </div>
</div>
{% endblock %}
{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.5/dist/chart.umd.min.js"></script>
<script>
  const ganttData = {{ gantt_data|safe }};
  const mandayData = {{ manday_chart|safe }};
  const canManageTasks = {{ 'true' if can_manage_tasks else 'false' }};
</script>
<script src="{{ url_for('static', filename='js/project_detail.js') }}"></script>
{% endblock %}
